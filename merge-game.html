<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø¯Ù…Ø¬ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ 6x6 + DA</title>
<style>
body{font-family:Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);margin:0;padding:15px;text-align:center;}
#startBtn,#googleLogin,#buyGemsBtn{padding:15px 30px;font-size:20px;border:none;border-radius:10px;cursor:pointer;margin:10px}
#startBtn{background:#4CAF50;color:#fff}
#googleLogin{background:#4285F4;color:#fff}
#buyGemsBtn{background:#FFA500;color:#fff}
#top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap}
#targetBox{font-size:24px;font-weight:bold}
#game{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;max-width:360px;width:90%;margin:15px auto}
.cell{background:#fff;border-radius:10px;height:50px;display:flex;justify-content:center;align-items:center;font-size:26px;cursor:pointer}
#activeUsers{max-width:360px;margin:15px auto;text-align:left;font-weight:bold}
</style>
</head>
<body>

<div id="userStatus">ğŸ‘¤ Ø£Ù†Øª ÙƒØ²Ø§Ø¦Ø±</div>
<button id="googleLogin">ØªØ³Ø¬ÙŠÙ„ ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
<button id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
<button id="buyGemsBtn">ğŸ’ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±</button>

<div>DA: <span id="da">0</span> | Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±: <span id="score">0</span></div>

<div id="gameContainer" style="display:none;">
  <div id="top">
    <div id="targetBox">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: <span id="target"></span></div>
  </div>
  <div id="game"></div>
  <div id="activeUsers">
    ğŸŸ¢ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†:
    <ul id="activeList"></ul>
  </div>
</div>

<audio id="sound">
  <source src="https://cdn.pixabay.com/audio/2022/03/15/audio_5c4f1d6d7a.mp3">
</audio>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBbdPvahZv6OSBumuFBd37mC61UXlsIm6k",
  authDomain: "naturebelkhirapp.firebaseapp.com",
  databaseURL: "https://naturebelkhirapp-default-rtdb.firebaseio.com",
  projectId: "naturebelkhirapp",
  storageBucket: "naturebelkhirapp.appspot.com",
  messagingSenderId: "318524052243",
  appId: "1:318524052243:web:5e14d79b0fa1eeef0280e6"
};
firebase.initializeApp(firebaseConfig);

const fruits=["ğŸ","ğŸŒ","ğŸŠ","ğŸ“","ğŸ","ğŸ…"];
const size=6;
let grid=[],selected=null;
let score=0,da=0,targetFruit="";
let user=null;

const game=document.getElementById("game");
const targetEl=document.getElementById("target");
const scoreEl=document.getElementById("score");
const daEl=document.getElementById("da");
const activeList=document.getElementById("activeList");

/* ===== Google Login ===== */
document.getElementById("googleLogin").onclick=async()=>{
  const provider=new firebase.auth.GoogleAuthProvider();
  const res=await firebase.auth().signInWithPopup(provider);
  user=res.user;
  document.getElementById("userStatus").textContent="ğŸ‘¤ "+user.displayName;
  document.getElementById("googleLogin").style.display="none";
  loadGame();
  updateActiveUsers();
};

/* ===== Start Game ===== */
document.getElementById("startBtn").onclick=()=>{
  document.getElementById("startBtn").style.display="none";
  document.getElementById("gameContainer").style.display="block";
  if(grid.length===0) initGrid();
  nextTarget();
  renderGrid();
};

/* ===== Buy Gems ===== */
document.getElementById("buyGemsBtn").onclick = async ()=>{
    if(!user) return alert("Ø³Ø¬Ù„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø´Ø±Ø§Ø¡");
    let gemsToBuy = prompt("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¦Ù‡Ø§:");
    if(!gemsToBuy) return;
    gemsToBuy = Number(gemsToBuy);
    if(isNaN(gemsToBuy) || gemsToBuy<=0) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­");

    const paymentInfo = {}; // Ø¶Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù‡Ù†Ø§

    const res = await fetch("/api/buy", {
        method:"POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ id:user.uid, gemsToBuy, paymentInfo })
    });
    const data = await res.json();
    if(res.ok){
        alert(data.message);
        loadGame();
    } else {
        alert("ÙØ´Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡: "+data.error);
    }
};

/* ===== Game Logic ===== */
function initGrid(){
  grid=[];
  for(let r=0;r<size;r++){
    let row=[];
    for(let c=0;c<size;c++) row.push(randomFruit());
    grid.push(row);
  }
}

function randomFruit(){
  if(targetFruit && Math.random()<0.25) return targetFruit;
  return fruits[Math.floor(Math.random()*fruits.length)];
}

function renderGrid(){
  game.innerHTML="";
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.textContent=grid[r][c];
      cell.onclick=()=>selectCell(r,c);
      game.appendChild(cell);
    }
  }
}

function selectCell(r,c){
  if(!selected){ selected=[r,c]; return; }
  const [sr,sc]=selected;
  if(grid[sr][sc]===grid[r][c] && !(sr===r&&sc===c)){
    grid[sr][sc]=randomFruit();
    grid[r][c]=randomFruit();
    checkRows();
  }
  selected=null;
  renderGrid();
  saveGame();
}

function checkRows(){
  for(let r=0;r<size;r++){
    if(grid[r].every(f=>f===targetFruit)){
      grid[r]=grid[r].map(()=>randomFruit());
      daEl.textContent=da;
      scoreEl.textContent=score;
      document.getElementById("sound").play();
      nextTarget();
      break;
    }
  }
}

function nextTarget(){
  let t;
  do{ t=fruits[Math.floor(Math.random()*fruits.length)]; }
  while(t===targetFruit);
  targetFruit=t;
  targetEl.textContent=t;
}

/* ===== Firebase Save / Load ===== */
function saveGame(){
  if(!user) return;
  firebase.database().ref("games/"+user.uid).set({
    name:user.displayName,
    grid,score,da,targetFruit,
    lastActive:Date.now()
  });
}

function loadGame(){
  if(!user) return;
  firebase.database().ref("games/"+user.uid).once("value",snap=>{
    if(!snap.exists()) return;
    const d=snap.val();
    grid=d.grid||[];
    score=d.score||0;
    da=d.da||0;
    targetFruit=d.targetFruit||"";
    scoreEl.textContent=score;
    daEl.textContent=da;
    renderGrid();
  });
}

/* ===== Active Users ===== */
function updateActiveUsers(){
  firebase.database().ref("games")
    .orderByChild("lastActive")
    .startAt(Date.now()-300000)
    .on("value",snap=>{
      activeList.innerHTML="";
      snap.forEach(s=>{
        activeList.innerHTML+=`<li>${s.val().name} - Ù†Ù‚Ø§Ø·: ${s.val().score}</li>`;
      });
    });
}
</script>
</body>
</html>