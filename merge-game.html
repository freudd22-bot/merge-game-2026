<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„Ø¹Ø¨Ø© Ø¯Ù…Ø¬ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ 6x6 + DA</title>
<style>
body{font-family:Tahoma,Arial,sans-serif;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);margin:0;padding:15px;text-align:center;}
#startBtn,#loginBtn,#buyGems{padding:15px 30px;font-size:20px;border:none;border-radius:10px;cursor:pointer;margin:10px}
#startBtn{background:#4CAF50;color:#fff}
#loginBtn{background:#4285F4;color:#fff}
#buyGems{background:#FF9800;color:#fff}
#top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap}
#targetBox{font-size:24px;font-weight:bold}
#game{display:grid;grid-template-columns:repeat(6,1fr);gap:6px;max-width:360px;width:90%;margin:15px auto}
.cell{background:#fff;border-radius:10px;height:50px;display:flex;justify-content:center;align-items:center;font-size:26px;cursor:pointer}
#activeUsers{max-width:360px;margin:15px auto;text-align:left;font-weight:bold}
</style>
</head>
<body>

<div id="userStatus">ğŸ‘¤ Ø£Ù†Øª ÙƒØ²Ø§Ø¦Ø±</div>
<button id="loginBtn">ØªØ³Ø¬ÙŠÙ„/ØªØ¬Ø±Ø¨Ø©</button>
<button id="startBtn">â–¶ï¸ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
<button id="buyGems" style="display:none;">ğŸ’ Ø´Ø±Ø§Ø¡ Ø¬ÙˆÙ‡Ø±Ø©</button>

<div id="gameContainer" style="display:none;">
  <div id="top">
    <div id="targetBox">ğŸ¯ Ø§Ù„Ù‡Ø¯Ù: <span id="target"></span></div>
    <div>â­ Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
    <div>DA: <span id="da">0</span></div>
    <div>ğŸ’ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±: <span id="gems">0</span></div>
  </div>

  <div id="game"></div>

  <div id="activeUsers">
    ğŸŸ¢ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù†Ø´Ø·ÙˆÙ†:
    <ul id="activeList"></ul>
  </div>
</div>

<script>
const fruits=["ğŸ","ğŸŒ","ğŸŠ","ğŸ“","ğŸ","ğŸ…"];
const size=6;
let grid=[],selected=null;
let score=0,da=0,gems=0,targetFruit="";
let user=null;

const game=document.getElementById("game");
const targetEl=document.getElementById("target");
const scoreEl=document.getElementById("score");
const daEl=document.getElementById("da");
const gemsEl=document.getElementById("gems");
const activeList=document.getElementById("activeList");

// ØªØ³Ø¬ÙŠÙ„/ØªØ¬Ø±Ø¨Ø© Ù…Ø³ØªØ®Ø¯Ù…
document.getElementById("loginBtn").onclick=async()=>{
    let email = prompt("Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ (ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„Ù„Ø²Ø§Ø¦Ø±)");
    let guestId = !email ? "guest_"+Date.now() : null;
    const res = await fetch("https://merge-game-2026-production-a52b.up.railway.app/api/login",{
        method:"POST", headers:{'Content-Type':'application/json'}, body:JSON.stringify({email, guestId})
    });
    user = await res.json();
    score=user.points; da=user.da; gems=user.gems;
    document.getElementById("userStatus").textContent = email ? "ğŸ‘¤ "+email : "ğŸ‘¤ Ø²Ø§Ø¦Ø±";
    document.getElementById("loginBtn").style.display="none";
    document.getElementById("buyGems").style.display=email ? "inline-block" : "none";
    renderStats();
    loadGame();
};

// Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
document.getElementById("startBtn").onclick=()=>{
    document.getElementById("startBtn").style.display="none";
    document.getElementById("gameContainer").style.display="block";
    if(grid.length===0) initGrid();
    nextTarget();
    renderGrid();
};

// Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±
document.getElementById("buyGems").onclick=async()=>{
    let amount = parseInt(prompt("ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¦Ù‡Ø§ØŸ"));
    if(!amount || amount<1) return;
    const res = await fetch("https://merge-game-2026-production-a52b.up.railway.app/api/charge",{
        method:"POST",
        headers:{'Content-Type':'application/json','x-api-key':'MERGE_GAME_2026_SECRET_KEY'},
        body:JSON.stringify({id:user.id,gems:amount})
    });
    const data = await res.json();
    gems=data.balance;
    renderStats();
    alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${amount} Ø¬ÙˆÙ‡Ø±Ø©!`);
});

function renderStats(){
    scoreEl.textContent=score;
    daEl.textContent=da;
    gemsEl.textContent=gems;
}

function initGrid(){
  grid=[];
  for(let r=0;r<size;r++){
    let row=[];
    for(let c=0;c<size;c++) row.push(randomFruit());
    grid.push(row);
  }
}

function randomFruit(){
  if(targetFruit && Math.random()<0.25) return targetFruit;
  return fruits[Math.floor(Math.random()*fruits.length)];
}

function renderGrid(){
  game.innerHTML="";
  for(let r=0;r<size;r++){
    for(let c=0;c<size;c++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.textContent=grid[r][c];
      cell.onclick=()=>selectCell(r,c);
      game.appendChild(cell);
    }
  }
}

function selectCell(r,c){
  if(!selected){ selected=[r,c]; return; }
  const [sr,sc]=selected;
  if(grid[sr][sc]===grid[r][c] && !(sr===r&&sc===c)){
    grid[sr][sc]=randomFruit();
    grid[r][c]=randomFruit();
    checkRows();
  }
  selected=null;
  renderGrid();
  saveGame();
}

function checkRows(){
  for(let r=0;r<size;r++){
    if(grid[r].every(f=>f===targetFruit)){
      grid[r]=grid[r].map(()=>randomFruit());
      score+=10;
      if(score>=1000){ da+=10; score=score%1000; }
      renderStats();
      nextTarget();
      break;
    }
  }
}

function nextTarget(){
  let t;
  do{ t=fruits[Math.floor(Math.random()*fruits.length)]; }while(t===targetFruit);
  targetFruit=t;
  targetEl.textContent=t;
}

function saveGame(){
    if(!user) return;
    localStorage.setItem(user.id, JSON.stringify({grid,score,da,gems,targetFruit}));
}

function loadGame(){
    if(!user) return;
    const data = JSON.parse(localStorage.getItem(user.id) || "{}");
    if(data.grid) { grid=data.grid; score=data.score; da=data.da; gems=data.gems; targetFruit=data.targetFruit; renderStats(); renderGrid(); }
}
</script>
</body>
</html>